#!/bin/sh

# ENTRY POINT (old / done)

set -e

$CITHOME/ci-update-common

if [ -z "$1" ]; then
 freebsd-update --not-running-from-cron fetch
 freebsd-update --not-running-from-cron install || true
 pyver=39
else
 pyver=39
fi

pkg upgrade -y

# Required
pkg install -y                       \
 asciidoc                            \
 autoconf                            \
 automake                            \
 autotools                           \
 bison                               \
 byacc                               \
 bzip2                               \
 check                               \
 cmocka                              \
 curl                                \
 dbus                                \
 docbook-xsl                         \
 doxygen                             \
 e2fsprogs-libuuid                   \
 flex                                \
 flock                               \
 gcc                                 \
 getopt                              \
 gettext                             \
 gettext-tools                       \
 git                                 \
 glib                                \
 gmake                               \
 gnutls                              \
 groff                               \
 gsnmp                               \
 help2man                            \
 jq                                  \
 libgcrypt                           \
 libltdl                             \
 liblz4                              \
 libqb                               \
 libxml2                             \
 libxslt                             \
 lzma                                \
 lzo2                                \
 pkgconf                             \
 ncurses                             \
 nss                                 \
 openipmi                            \
 p5-Locale-gettext                   \
 py${pyver}-boto3                    \
 py${pyver}-google-api-python-client \
 py${pyver}-keystoneauth1            \
 py${pyver}-pexpect                  \
 py${pyver}-pycurl                   \
 py${pyver}-python-keystoneclient    \
 py${pyver}-python-novaclient        \
 py${pyver}-requests                 \
 py${pyver}-suds                     \
 rsync                               \
 zstd

# Optional
pkg install -y  \
 net-snmp       \
 || true

if [ -n "$RUSTBINDINGS" ] && [ "$RUSTBINDINGS" = yes ]; then
 pkg install -y   \
  rust   \
  rust-bindgen-cli
fi

pkg clean -a -y
pkg autoremove -y
getent group haclient >/dev/null || pw groupadd haclient
getent passwd hacluster >/dev/null || pw useradd hacluster -g haclient -s /nonexistent -c "cluster user"
